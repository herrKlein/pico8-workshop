pico-8 cartridge // http://www.pico-8.com
version 39
__lua__

-- explain why colission is not working
-- refactor into correct colission
-- add other flags

grav = 0.04 -- 1. adapt to game gravity
flap = 1
nrg = 50
fri = 3
ground = 128-20
map_speed = 1

function _init()
 plr = {
  size={w=16,h=16},
  pos={x=10, y=10},
  move = {
   vy = 0,
   bounce = -1
  }
 }
	map_x = 0
end

function _update60()
 
 local flag, tile = collide(plr, abs(map_x))
--  printh(flag)
 if flag == 5 then
  mset(tile.x,tile.y,0)
 end


 if btn(4) and nrg > 0 then 
  -- plr.pos.y -= flap
  plr.move.vy = sgn(plr.move.v) * -1
  -- nrg -= 1
 end
  plr.move.vy += grav
  plr.pos.y += plr.move.vy
  if plr.pos.y > ground then
   plr.move.vy *= plr.move.bounce
   plr.pos.y = ground
   
   -- to decide to adapt nrg or vel
   if flag == 3 then
    plr.move.vy += 0.2 * plr.move.vy -- extra bounce
   else
    plr.move.vy -= 0.6 * plr.move.vy -- apply friction
   end
   if abs(plr.move.vy) < 0.1 then plr.move.vy = 0 end
   
   nrg = 50
  end
 

 map_x -= map_speed
end

function _draw()
 cls(12)
 print(plr.move.vy, 20,0,7)
 map(0, 0, map_x, 0, 128, 16)
 spr(1, plr.pos.x, plr.pos.y, 2, 2)
end
-->8
-- hit collission

function collide(plr, map_x) -- returns flag,tile if hit
  -- Calculate the tile indices of the four corners of the sprite
  local corners = {
    {x = plr.pos.x + plr.size.w/2, y = plr.pos.y},
    {x = plr.pos.x + plr.size.w, y = plr.pos.y + plr.size.h/2},
    {x = plr.pos.x, y = plr.pos.y + plr.size.h/2},
    {x = plr.pos.x + plr.size.w/2, y = plr.pos.y + plr.size.h}
  }
  for i, corner in ipairs(corners) do
    pset(corner.x, corner.y, 10)
    -- Calculate the tile index of the current corner
    local tile_x = flr((map_x + corner.x) / 8)
    local tile_y = flr(corner.y / 8)
    -- Check if the tile is solid
    local flag = fget(mget(tile_x, tile_y))

    if flag>0 then
      return flag, {x=tile_x, y=tile_y}
    end
  end

  -- No collision detected
  return nil, nil
end



__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000aaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000099aaaaaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009aaaaaaaa1aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009aaaaaaaaaa88000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000009aaaadaaaaa888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000009aaadaadaaaaa8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000009daaddd9aaaaa9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009da999aaaaad0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009ddaaaaaadd90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000099dddddd9900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000009999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbb0000000033333333000000e88820000000000000007aa90000000000006d5000000000000000000000000000000000000000000000000000
00000000bbbbbbbb000000003333333300000e88888200000000000007aaaa900000000006d55550000000000000000000000000000000000000000000000000
00000000bbbbbbbb00000000333333330000e88008882000000000007aaaaaa90000000055556650000000000000000000000000000000000000000000000000
00000000bbbbbbbb0000000033333333000e88000088820000000000aaaaaaa9000000006556dddd000000000000000000000000000000000000000000000000
00000000bbbbbbbb0000000033333333000e80000008820000000000aaaaaaa900000000dd5ddddd000000000000000000000000000000000000000000000000
00000000bbbbbbbb0000000033333333000e80000008820000000000aaaaaaa9000000000d5dddd5000000000000000000000000000000000000000000000000
0000000044444444000000004444444400e8800000088820000000000aaaaa90000000000555dd50000000000000000000000000000000000000000000000000
0000000044444444000000004444444400e80000000088200000000000aaa9000000000000055500000000000000000000000000000000000000000000000000
0000000000000000000000000000000000e800000000882000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000008800000000882000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088800000000888200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088000000000088200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088800000000888200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000008800000000e82000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000008800000000e82000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000008800000000e82000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000888000000e882000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000088000000e820000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000088000000e820000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000008880000e8820000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000088800e88200000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000888e882000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000888820000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000050009000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000474747000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000047474747474700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000004747474747474747000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000047474747474747000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000444500000000
0000000000004747474747474747000047000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000545500000000
0000000000004747474747474700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000646500000000
0000000000004747474747474700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000747500000000
0000000000000000474700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4343434343434343434341434343434343434143434343434343414343434343434343434343434143434343434343414343434343414141414141414343434343434341434343434343434141434343434343434343414343434343434343434343434343434343434343434343434343434343434343434343434343434343
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
